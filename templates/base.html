{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TerraStudio | Gesti√≥n Inmobiliaria & Topograf√≠a</title>
    <link rel="icon" href="{% static 'img/logo-icono.png' %}" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    
    <style>
        /* ESTILOS GLOBALES */
        .bg-technical { background-color: #2C3E50; }
        .text-technical { color: #2C3E50; }
        .nav-link { font-weight: 500; color: #2C3E50 !important; margin-right: 15px; }
        .nav-link:hover { color: #198754 !important; }
        .nav-link.active { color: #198754 !important; font-weight: 700; }

        .btn-terra-outline { color: #2C3E50; border-color: #2C3E50; }
        .btn-terra-outline:hover { background-color: #198754; border-color: #198754; color: white; }
        
        .footer-link { text-decoration: none; color: rgba(255, 255, 255, 0.75) !important; transition: color 0.2s ease; }
        .footer-link:hover { color: #198754 !important; }
        
        .social-icon { display: inline-flex; align-items: center; justify-content: center; width: 36px; height: 36px; background-color: rgba(255, 255, 255, 0.1); color: white; border-radius: 50%; text-decoration: none; transition: all 0.3s ease; }
        .social-icon:hover { background-color: #198754; color: white; transform: translateY(-3px); }
        .ls-1 { letter-spacing: 1px; }

        /* ESTILOS DEL WIZARD (CONTACTO) */
        .transition-all { transition: all 0.3s ease; }
        .hover-scale:hover { transform: scale(1.02); }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .icon-circle { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        
        .btn-option { background: white; border-color: #dee2e6; }
        .btn-option:hover { border-color: #198754; background-color: #f8fffb; }
        .btn-option.active { background-color: #e9f7ef; border-color: #198754; border-width: 2px; }
        .btn-option.active .icon-circle { background-color: #198754 !important; color: white !important; }

        .btn-channel { background: white; color: #555; }
        .btn-channel:hover { border-color: #198754; color: #198754; }
        .btn-channel.active { background-color: #198754; color: white; border-color: #198754; }

        .vertical-line { width: 2px; height: 30px; background-color: #dee2e6; }

        /* ESTILOS RECURSOS & CARDS */
        .hover-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .hover-card:hover { transform: translateY(-5px); box-shadow: 0 1rem 3rem rgba(0,0,0,.1) !important; }
        .img-zoom { transition: transform 0.5s ease; }
        .hover-card:hover .img-zoom { transform: scale(1.05); }
        .stretched-link::after { position: absolute; top: 0; right: 0; bottom: 0; left: 0; z-index: 1; content: ""; }

        /* ESTILOS DEL BOT√ìN WHATSAPP (Avanzado) */
        .btn-whatsapp-trigger {
            background-color: #25D366; 
            border: none;
            transition: all 0.3s ease;
            color: white;
            position: relative;
            z-index: 1002;
        }
        
        .btn-whatsapp-trigger:hover {
            background-color: #1DA851; 
            transform: scale(1.05);    
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4) !important;
        }

        .btn-whatsapp-real {
            background-color: #25D366;
            transition: background-color 0.2s;
        }
        .btn-whatsapp-real:hover {
            background-color: #1DA851;
        }

        /* ESTILOS DEL GLOBO (SPEECH BUBBLE) */
        #whatsapp-tooltip {
            opacity: 0;
            visibility: hidden;
            transform: translateX(-15px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background-color: white;
            color: #333;
            /* IMPORTANTE: Quitamos box-shadow para usar filter */
            box-shadow: none !important;
            /* El filtro dibuja la sombra alrededor de la forma combinada (globo + flecha) */
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
            z-index: 1001;
            /* Hacemos espacio para que la flecha no toque el bot√≥n verde */
            margin-right: 14px; 
            overflow: visible !important;
        }

        /* LA FLECHA (TRI√ÅNGULO INVASOR) */
        #whatsapp-tooltip::after {
            content: "";
            position: absolute;
            top: 50%;
            /* TRUCO MAESTRO: */
            /* En lugar de 100%, usamos calc() para meter la flecha 1px DENTRO del globo */
            left: calc(100% - 1px); 
            margin-top: -6px;
            border-width: 6px;
            border-style: solid;
            /* La flecha apunta a la derecha */
            border-color: transparent transparent transparent white;
        }

        /* AL HACER HOVER */
        #whatsapp-widget:hover #whatsapp-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }
        
        .chat-is-open #whatsapp-tooltip {
            display: none !important;
        }
    </style>
</head>
<body class="bg-light d-flex flex-column min-vh-100">

    <nav class="navbar navbar-expand-md navbar-light bg-white sticky-top shadow-sm py-3">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="{% url 'inicio' %}" style="font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; font-size: 1.6rem; letter-spacing: -0.5px;">
                <img src="{% static 'img/logo-icono.png' %}" alt="TerraStudio" height="60" class="me-1">
                <div class="lh-1">
                    <span style="color: #2C3E50; font-weight: 800;">Terra</span><span style="color: #198754; font-weight: 400;">Studio</span>
                </div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item"><a class="nav-link" href="{% url 'servicios' %}">Servicios</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'catalogo' %}">Propiedades</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'nosotros' %}">Nosotros</a></li>
                    <li class="nav-item ms-md-3 mt-3 mt-md-0">
                        <a class="btn btn-terra-outline px-4 rounded-pill" href="#contacto-interactivo">Contacto</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main>
        {% block content %}
        {% endblock %}
    </main>

    {% if propiedades and not is_catalog_page %}
    <section class="py-5 bg-light border-top">
        <div class="container">
            <div class="d-flex justify-content-between align-items-end mb-4">
                <div>
                    <h6 class="text-success fw-bold text-uppercase ls-2 small">Oportunidades Recientes</h6>
                    <h2 class="fw-bold text-technical">Propiedades Destacadas</h2>
                </div>
                
                <a href="{% url 'catalogo' %}" class="btn btn-outline-dark rounded-pill px-4 fw-bold small d-none d-md-inline-flex align-items-center">
                    Ver Cat√°logo Completo <i class="bi bi-arrow-right ms-1"></i>
                </a>
            </div>

            <div class="row row-cols-1 row-cols-md-3 g-4">
                {% load humanize %}
                {% for prop in propiedades %}
                <div class="col">
                    <div class="card h-100 shadow-sm border-0 hover-lift position-relative">
                        
                        <div class="position-relative overflow-hidden rounded-top">
                            {% if prop.imagen_principal %}
                                <img src="{{ prop.imagen_principal.imagen.url }}" class="card-img-top" alt="{{ prop.titulo }}" style="height: 220px; object-fit: cover;">
                            {% else %}
                                <img src="https://via.placeholder.com/400x300" class="card-img-top" style="height: 220px; object-fit: cover;">
                            {% endif %}

                            <span class="position-absolute top-0 start-0 badge m-3 shadow-sm
                                {% if prop.operacion == 'VENTA' %} bg-success {% else %} bg-warning text-dark {% endif %}"
                                style="opacity: 0.9; font-weight: 600; letter-spacing: 0.5px;">
                                {{ prop.get_operacion_display }}
                            </span>
                        </div>

                        <div class="card-body">
                            <div class="text-uppercase text-muted fw-bold mb-1" style="font-size: 0.7rem; letter-spacing: 1px;">
                                {{ prop.get_tipo_display }}
                            </div>

                            <h5 class="card-title fw-bold mb-2 text-clamp-2">
                                <a href="{% url 'detalle_propiedad' prop.slug %}" 
                                onclick="event.preventDefault(); abrirModalPropiedad(this.href);" 
                                class="text-decoration-none text-technical stretched-link">
                                    {{ prop.titulo }}
                                </a>
                            </h5>

                            <p class="text-muted small mb-2"><i class="bi bi-geo-alt"></i> {{ prop.ubicacion_visual }}</p>
                            
                            <div class="mt-2">
                                {% if prop.precio_pesos_referencia %}
                                    <h5 class="fw-bold text-success mb-0">${{ prop.precio_pesos_referencia|intcomma }}</h5>
                                    <small class="text-muted" style="font-size: 0.8rem;">
                                        {{ prop.precio_uf_visual }} UF
                                    </small>
                                {% else %}
                                    <h5 class="fw-bold text-success mb-0">{{ prop.precio_formateado }}</h5>
                                {% endif %}
                            </div>
                        </div>
                        </div>
                </div>
                {% endfor %}
            </div>

            <div class="d-block d-md-none text-center mt-4">
                <a href="{% url 'catalogo' %}" class="btn btn-outline-dark rounded-pill w-100 fw-bold">Ver Cat√°logo Completo</a>
            </div>
        </div>
    </section>
    {% endif %}

    <section class="py-5 bg-light" id="contacto-interactivo">
        <div class="container">
            {% if messages %}
            <div class="row justify-content-center mb-4">
                <div class="col-lg-8">
                    {% for message in messages %}
                        <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show shadow-sm" role="alert">
                            <i class="bi bi-check-circle-fill me-2"></i> {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
            <div class="text-center mb-5">
                <h3 class="fw-bold text-technical">¬øTienes un proyecto en mente?</h3>
                <p class="text-muted mx-auto" style="max-width: 700px;">
                    Cada caso es √∫nico. Ponte en contacto con nosotros y cu√©ntanos tu proyecto, queremos brindarte el asesoramiento exacto que necesitas.
                </p>
                <h5 class="text-success fw-bold mt-4">Selecciona el √°rea de tu inter√©s:</h5>
            </div>

            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="bg-white p-4 p-md-5 rounded-4 shadow-sm position-relative">
                        
                        <div class="row g-3 justify-content-center" id="step-1">
                            <div class="col-6 col-md-3">
                                <button class="btn-option w-100 h-100 p-3 rounded-4 border text-center transition-all" onclick="selectCategory(this, 'inmobiliaria')">
                                    <div class="icon-circle mb-3 mx-auto bg-light text-technical"><i class="bi bi-house-door-fill fs-3"></i></div>
                                    <span class="fw-bold small d-block">Operaciones Inmobiliarias</span>
                                </button>
                            </div>
                            <div class="col-6 col-md-3">
                                <button class="btn-option w-100 h-100 p-3 rounded-4 border text-center transition-all" onclick="selectCategory(this, 'topografia')">
                                    <div class="icon-circle mb-3 mx-auto bg-light text-technical"><i class="bi bi-layers-half fs-3"></i></div>
                                    <span class="fw-bold small d-block">Ingenier√≠a y Topograf√≠a</span>
                                </button>
                            </div>
                            <div class="col-6 col-md-3">
                                <button class="btn-option w-100 h-100 p-3 rounded-4 border text-center transition-all" onclick="selectCategory(this, 'legal')">
                                    <div class="icon-circle mb-3 mx-auto bg-light text-technical"><i class="bi bi-file-earmark-text fs-3"></i></div>
                                    <span class="fw-bold small d-block">Legal y Regularizaci√≥n</span>
                                </button>
                            </div>
                            <div class="col-6 col-md-3">
                                <button class="btn-option w-100 h-100 p-3 rounded-4 border text-center transition-all" onclick="selectCategory(this, 'tasaciones')">
                                    <div class="icon-circle mb-3 mx-auto bg-light text-technical"><i class="bi bi-graph-up-arrow fs-3"></i></div>
                                    <span class="fw-bold small d-block">Tasaciones</span>
                                </button>
                            </div>
                        </div>

                        <div id="connector-1" class="text-center py-3 d-none fade-in">
                            <div class="vertical-line mx-auto"></div>
                            <span class="badge bg-light text-muted border px-3 py-2 rounded-pill mt-2">Espec√≠ficamente busco:</span>
                        </div>

                        <div class="row g-3 justify-content-center d-none fade-in" id="step-2"></div>

                        <div id="connector-2" class="text-center py-3 d-none fade-in">
                            <div class="vertical-line mx-auto"></div>
                            <span class="badge bg-light text-muted border px-3 py-2 rounded-pill mt-2">Prefiero contactar por:</span>
                        </div>

                        <div class="row g-3 justify-content-center d-none fade-in" id="step-3">
                            <div class="col-6 col-md-3">
                                <button class="btn-channel w-100 p-2 rounded-pill border text-center transition-all" onclick="selectChannel(this, 'videollamada')"><i class="bi bi-camera-video me-2"></i> Videollamada</button>
                            </div>
                            <div class="col-6 col-md-3">
                                <button class="btn-channel w-100 p-2 rounded-pill border text-center transition-all" onclick="selectChannel(this, 'presencial')"><i class="bi bi-people me-2"></i> Presencial</button>
                            </div>
                            <div class="col-6 col-md-3">
                                <button class="btn-channel w-100 p-2 rounded-pill border text-center transition-all" onclick="selectChannel(this, 'email')"><i class="bi bi-envelope me-2"></i> Correo</button>
                            </div>
                            <div class="col-6 col-md-3">
                                <button class="btn-channel w-100 p-2 rounded-pill border text-center transition-all" onclick="selectChannel(this, 'whatsapp')"><i class="bi bi-whatsapp me-2"></i> WhatsApp</button>
                            </div>
                        </div>

                        <div id="connector-3" class="text-center py-3 d-none fade-in">
                            <div class="vertical-line mx-auto"></div>
                        </div>

                        <div class="row justify-content-center d-none fade-in" id="step-4">
                            <div class="col-md-8">
                                <div class="card bg-light border-0 p-4 rounded-4 text-center">
                                    <h5 class="fw-bold text-technical mb-3">¬°Perfecto!</h5>
                                    <p class="small text-muted mb-4">D√©janos tus datos para coordinar.</p>
                                    
                                    <form action="{% url 'enviar_contacto' %}" method="POST" id="contactForm">
                                        {% csrf_token %}
                                        
                                        <input type="hidden" name="categoria" id="input-categoria">
                                        <input type="hidden" name="subcategoria" id="input-subcategoria">
                                        <input type="hidden" name="canal" id="input-canal">

                                        <div class="row g-3 text-start">
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold text-technical">Nombre *</label>
                                                <input type="text" name="nombre" class="form-control rounded-3" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold text-technical">Tel√©fono / WhatsApp *</label>
                                                <input type="tel" name="telefono" class="form-control rounded-3" required>
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label small fw-bold text-technical" id="label-email">Correo Electr√≥nico</label>
                                                <input type="email" name="email" id="input-email" class="form-control rounded-3">
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label small fw-bold text-technical">Detalles adicionales</label>
                                                <textarea name="mensaje" class="form-control rounded-3" rows="3"></textarea>
                                            </div>
                                            <div class="col-12 mt-4">
                                                <button type="submit" class="btn btn-success w-100 py-3 rounded-pill fw-bold shadow-sm hover-scale">
                                                    Enviar Solicitud <i class="bi bi-send ms-2"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </section>
    {% comment %}
    <section class="py-5 bg-white border-top" id="recursos">
        <div class="container">
            <div class="d-flex justify-content-between align-items-end mb-5">
                <div>
                    <h6 class="text-success fw-bold text-uppercase ls-2 small">Conocimiento Experto</h6>
                    <h2 class="fw-bold text-technical">Gu√≠a y Actualidad</h2>
                </div>
            </div>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card h-100 border-0 shadow-sm hover-card">
                        <div class="overflow-hidden rounded-top position-relative">
                            <img src="https://images.unsplash.com/photo-1621905251189-08b45d6a269e?auto=format&fit=crop&q=80&w=800" class="card-img-top img-zoom" style="height: 200px; object-fit: cover;">
                            <span class="badge bg-technical position-absolute top-0 start-0 m-3">T√©cnico</span>
                        </div>
                        <div class="card-body p-4">
                            <small class="text-muted d-block mb-2"><i class="bi bi-calendar3 me-1"></i> Enero 2026</small>
                            <h5 class="fw-bold text-technical mb-3">¬øPor qu√© medir antes de comprar?</h5>
                            <p class="text-muted small mb-4">Descubre c√≥mo un levantamiento topogr√°fico te protege de conflictos y problemas legales.</p>
                            <a href="#" class="text-success fw-bold text-decoration-none stretched-link">Leer Art√≠culo <i class="bi bi-arrow-right ms-1"></i></a>
                        </div>
                    </div>
                </div>
                 <div class="col-md-4">
                    <div class="card h-100 border-0 shadow-sm hover-card">
                        <div class="overflow-hidden rounded-top position-relative">
                            <img src="https://images.unsplash.com/photo-1450101499163-c8848c66ca85?auto=format&fit=crop&q=80&w=800" class="card-img-top img-zoom" style="height: 200px; object-fit: cover;">
                            <span class="badge bg-success position-absolute top-0 start-0 m-3">Legal</span>
                        </div>
                        <div class="card-body p-4">
                            <small class="text-muted d-block mb-2"><i class="bi bi-calendar3 me-1"></i> Diciembre 2025</small>
                            <h5 class="fw-bold text-technical mb-3">Estudio de T√≠tulos: Tu seguro.</h5>
                            <p class="text-muted small mb-4">No basta con que el vendedor diga que es due√±o. Explicamos el proceso de revisi√≥n.</p>
                            <a href="#" class="text-success fw-bold text-decoration-none stretched-link">Leer Art√≠culo <i class="bi bi-arrow-right ms-1"></i></a>
                        </div>
                    </div>
                </div>
                 <div class="col-md-4">
                    <div class="card h-100 border-0 shadow-sm hover-card">
                        <div class="overflow-hidden rounded-top position-relative">
                            <img src="https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?auto=format&fit=crop&q=80&w=800" class="card-img-top img-zoom" style="height: 200px; object-fit: cover;">
                            <span class="badge bg-secondary position-absolute top-0 start-0 m-3">Historia</span>
                        </div>
                        <div class="card-body p-4">
                            <small class="text-muted d-block mb-2"><i class="bi bi-calendar3 me-1"></i> Noviembre 2025</small>
                            <h5 class="fw-bold text-technical mb-3">30 A√±os en Tom√©.</h5>
                            <p class="text-muted small mb-4">Desde las primeras mediciones manuales hasta el uso de drones. Conoce nuestra evoluci√≥n.</p>
                            <a href="#" class="text-success fw-bold text-decoration-none stretched-link">Leer Art√≠culo <i class="bi bi-arrow-right ms-1"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    {% endcomment %}

    <script>
        const subOpciones = {
            'inmobiliaria': [
                {icon: 'bi-house-check', text: 'Me interesa Comprar'},
                {icon: 'bi-currency-dollar', text: 'Me interesa Vender'},
                {icon: 'bi-key', text: 'Gesti√≥n / Arriendo'}
            ],
            'topografia': [
                {icon: 'bi-geo', text: 'Topograf√≠a General'},
                {icon: 'bi-grid-3x3', text: 'Subdivisi√≥n (Rural/Urbana)'},
                {icon: 'bi-airplane', text: 'Fotogrametr√≠a / Drones'}
            ],
            'legal': [
                {icon: 'bi-file-earmark-check', text: 'Regularizaci√≥n Terreno'},
                {icon: 'bi-search', text: 'Estudio de T√≠tulos'},
                {icon: 'bi-journal-text', text: 'Asesor√≠a Legal General'}
            ],
            'tasaciones': [
                {icon: 'bi-shop', text: 'Tasaci√≥n Comercial'},
                {icon: 'bi-tree', text: 'Tasaci√≥n Agr√≠cola'},
                {icon: 'bi-clipboard-data', text: 'Tasaci√≥n Bancaria'}
            ]
        };

        let categoriaSeleccionada = '';
        let subServicioSeleccionado = '';

        function selectCategory(btn, categoria) {
            document.getElementById('input-categoria').value = categoria;
            document.querySelectorAll('#step-1 .btn-option').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            categoriaSeleccionada = categoria;

            const step2Div = document.getElementById('step-2');
            step2Div.innerHTML = ''; 
            
            subOpciones[categoria].forEach(opcion => {
                const col = document.createElement('div');
                col.className = 'col-6 col-md-4';
                col.innerHTML = `
                    <button class="btn-channel w-100 p-3 rounded-pill border text-center transition-all" onclick="selectSubService(this, '${opcion.text}')">
                        <i class="bi ${opcion.icon} me-2"></i> ${opcion.text}
                    </button>
                `;
                step2Div.appendChild(col);
            });

            document.getElementById('connector-1').classList.remove('d-none');
            step2Div.classList.remove('d-none');
            
            document.getElementById('connector-2').classList.add('d-none');
            document.getElementById('step-3').classList.add('d-none');
            document.getElementById('connector-3').classList.add('d-none');
            document.getElementById('step-4').classList.add('d-none');

            setTimeout(() => document.getElementById('step-2').scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
        }

        function selectSubService(btn, nombreServicio) {
            document.getElementById('input-subcategoria').value = nombreServicio;
            document.querySelectorAll('#step-2 button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            subServicioSeleccionado = nombreServicio;

            document.getElementById('connector-2').classList.remove('d-none');
            document.getElementById('step-3').classList.remove('d-none');
            setTimeout(() => document.getElementById('step-3').scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
        }

        function selectChannel(btn, canal) {
            document.getElementById('input-canal').value = canal;
            document.querySelectorAll('#step-3 .btn-channel').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const labelEmail = document.getElementById('label-email');
            const inputEmail = document.getElementById('input-email');
            if (canal === 'email') {
                labelEmail.innerText = "Correo Electr√≥nico (Requerido)";
                inputEmail.required = true;
            } else {
                labelEmail.innerText = "Correo Electr√≥nico (Opcional)";
                inputEmail.required = false;
            }

            document.getElementById('connector-3').classList.remove('d-none');
            document.getElementById('step-4').classList.remove('d-none');
            setTimeout(() => document.getElementById('step-4').scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
        }
    </script>

    <footer class="bg-technical text-white pt-5 pb-3 mt-auto">
        <div class="container">
            <div class="row g-4 mb-4">
                <div class="col-lg-4 mb-3 mb-lg-0">
                    <a class="d-flex align-items-center text-white text-decoration-none mb-3" href="{% url 'inicio' %}">
                        <img src="{% static 'img/logo-icono.png' %}" alt="TerraStudio" height="40" class="me-2" style="filter: brightness(0) invert(1);"> 
                        <div class="lh-1">
                            <span class="fw-bold">Terra</span><span class="fw-light">Studio</span>
                        </div>
                    </a>
                    <p class="text-white-50 small pe-lg-5">
                        Gesti√≥n inmobiliaria con respaldo topogr√°fico en Tom√© y alrededores. Transformamos problemas complejos en soluciones claras desde 2013
                    </p>
                </div>
                <div class="col-6 col-sm-4 col-lg-2 mb-3 mb-sm-0">
                    <h5 class="fw-bold mb-3">Navegaci√≥n</h5>
                    <ul class="list-unstyled small">
                        <li class="mb-2">
                            <a href="{% url 'inicio' %}" class="footer-link">Inicio</a>
                        </li>
                        
                        <li class="mb-2">
                            <a href="{% url 'catalogo' %}" class="footer-link">Propiedades</a>
                        </li>
                        
                        <li class="mb-2">
                            <a href="{% url 'servicios' %}" class="footer-link">Servicios</a>
                        </li>
                        
                        <li class="mb-2">
                            <a href="{% url 'nosotros' %}" class="footer-link">Nosotros</a>
                        </li>
                    </ul>
                </div>
                <div class="col-6 col-sm-4 col-lg-3 mb-3 mb-sm-0">
                    <h5 class="fw-bold mb-3">Contacto</h5>
                    <ul class="list-unstyled small text-white-50">
                        <li class="mb-3 d-flex">
                            <i class="bi bi-geo-alt-fill text-success me-3 mt-1"></i>
                            <span>Jorge Montt, Dichato,<br>Comuna de Tom√©</span>
                        </li>
                        <li class="mb-3 d-flex align-items-center">
                            <i class="bi bi-whatsapp text-success me-3 fs-5"></i>
                            <a href="https://wa.me/56912345678" target="_blank" class="footer-link text-white">+56 9 7660 7301</a>
                        </li>
                        <li class="d-flex align-items-center">
                            <i class="bi bi-envelope-fill text-success me-3"></i>
                            <a href="mailto:contacto@terrastudio.cl" class="footer-link text-white">ruzbraulio@gmail.com</a>
                        </li>
                    </ul>
                </div>
                <div class="col-sm-4 col-lg-3">
                    <h5 class="fw-bold mb-3">S√≠guenos</h5>
                    <div class="d-flex mb-4">
                        <a href="https://www.linkedin.com/company/terrastudio-cl/" target="_blank" rel="noopener noreferrer" class="social-icon me-2">
                            <i class="bi bi-linkedin"></i>
                        </a>
                        <a href="https://www.facebook.com/TopografiaBienesRaices" target="_blank" rel="noopener noreferrer" class="social-icon me-2">
                            <i class="bi bi-facebook"></i>
                        </a>
                    </div>

                    <h6 class="fw-bold mb-3 mt-4 text-white">Respaldo Acad√©mico</h6>
                    
                    <div class="d-flex align-items-center gap-3">
                        <img src="{% static 'img/logo-udec.png' %}" 
                            alt="Universidad de Concepci√≥n" 
                            title="Universidad de Concepci√≥n"
                            style="height: 45px; width: auto; object-fit: contain; filter: brightness(0) invert(1); opacity: 0.9;">
                        
                        <img src="{% static 'img/logo-uc.png' %}" 
                            alt="Pontificia Universidad Cat√≥lica" 
                            title="Pontificia Universidad Cat√≥lica"
                            style="height: 40px; width: auto; object-fit: contain; filter: brightness(0) invert(1); opacity: 0.9;">
                        
                        <img src="{% static 'img/logo-uchile.png' %}" 
                            alt="Universidad de Chile" 
                            title="Universidad de Chile"
                            style="height: 45px; width: auto; object-fit: contain; filter: brightness(0) invert(1); opacity: 0.9;">
                    </div>
                </div>
            </div>
            <hr class="border-secondary my-4">
            <div class="row">
                <div class="col-12 text-center">
                    <small class="text-white-50">&copy; 2026 TerraStudio. Todos los derechos reservados.</small>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <div id="whatsapp-widget" class="position-fixed bottom-0 end-0 m-4" style="z-index: 1000;">
        
        <div id="whatsapp-tooltip" class="bg-white shadow-sm rounded-pill px-3 py-2 mb-2 position-absolute end-100 me-2 d-flex align-items-center" 
             style="top: 10px; width: max-content;">
            <span class="small fw-bold text-dark">¬øNecesitas ayuda?</span>
        </div>

        <div id="whatsapp-chat-window" class="card shadow border-0 mb-3 d-none" 
             style="width: 300px; position: absolute; bottom: 70px; right: 0; overflow: hidden; border-radius: 15px;">
            
            <div class="card-header text-white p-3 d-flex align-items-center" style="background-color: #075E54;">
                <div class="bg-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                    <img src="{% static 'img/logo-icono.png' %}" alt="TerraStudio" width="30">
                </div>
                <div>
                    <h6 class="mb-0 fw-bold">TerraStudio</h6>
                    <small style="font-size: 0.75rem;">Responde en menos de 1h</small>
                </div>
                <button type="button" class="btn-close btn-close-white ms-auto" aria-label="Close" onclick="toggleWhatsapp()"></button>
            </div>

            <div class="card-body bg-light p-4" style="background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');">
                <div class="bg-white p-2 rounded-3 shadow-sm d-inline-block text-dark small" style="border-top-left-radius: 0 !important;">
                    Hola üëã <br>Si tienes alguna consulta sobre un terreno, estamos aqu√≠ para ayudarte.
                </div>
                <div class="text-muted text-end mt-1" style="font-size: 0.7rem;">Justo ahora</div>
            </div>

            <div class="card-footer bg-white border-0 p-3">
                <a href="https://wa.me/5676607301?text=Hola,%20vengo%20de%20la%20web%20y%20tengo%20una%20consulta." target="_blank" class="btn w-100 rounded-pill fw-bold text-white d-flex align-items-center justify-content-center btn-whatsapp-real">
                    <i class="bi bi-whatsapp me-2 fs-5"></i> Iniciar Chat
                </a>
            </div>
        </div>

        <button onclick="toggleWhatsapp()" class="btn rounded-circle shadow d-flex align-items-center justify-content-center btn-whatsapp-trigger" 
                style="width: 60px; height: 60px;">
            <i class="bi bi-whatsapp text-white display-6"></i>
        </button>
    </div>

    <script>
        function toggleWhatsapp() {
            var chatWindow = document.getElementById('whatsapp-chat-window');
            var widgetContainer = document.getElementById('whatsapp-widget');
            
            if (chatWindow.classList.contains('d-none')) {
                chatWindow.classList.remove('d-none');
                widgetContainer.classList.add('chat-is-open'); 
            } else {
                chatWindow.classList.add('d-none');
                widgetContainer.classList.remove('chat-is-open');
            }
        }
    </script>
    
<div class="modal fade" id="modalPropiedad" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" id="modal-content-body">
            <div class="text-center py-5">
                <div class="spinner-border text-success" role="status"></div>
            </div>
        </div>
    </div>
</div>

<style>
    /* 1. Estilos para centrado y flechas */
    #lightbox-overlay {
        backdrop-filter: blur(5px); /* Efecto borroso pro */
    }
    
    .lightbox-nav {
        background-color: rgba(0, 0, 0, 0.5);
        border: none;
        color: white;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        font-size: 1.5rem;
        transition: background-color 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .lightbox-nav:hover { background-color: rgba(0,0,0,0.9); }

    /* 2. REGLA DE ORO PARA M√ìVIL: OCULTAR FLECHAS Y AJUSTAR IMAGEN */
    @media (max-width: 768px) {
        .lightbox-arrow-btn {
            display: none !important; /* Fuerza bruta para que no aparezcan */
        }
        #lightbox-img-tag {
            max-height: 65vh !important; /* M√°s peque√±a en m√≥vil para centrarla bien arriba de las miniaturas */
        }
        .lightbox-thumbs {
            padding-bottom: 20px; /* Levantar un poco las miniaturas del borde inferior */
        }
    }
</style>

<div id="lightbox-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; flex-direction: column; justify-content: center; align-items: center;">
    
    <button onclick="closeLightbox(null)" class="btn-close btn-close-white" 
            style="position: absolute; top: 20px; right: 20px; z-index: 10002; width: 2rem; height: 2rem; opacity: 1;"></button>
    
    <div class="position-relative d-flex justify-content-center align-items-center" 
         style="flex: 1; width: 100%; padding: 80px 10px 80px 10px;">
        
        <div onclick="event.stopPropagation(); changeLightboxImage(-1);" 
             style="position: absolute; left: 0; top: 80px; bottom: 80px; width: 35%; z-index: 3; cursor: pointer;"></div>
        
        <img id="lightbox-img-tag" src="" 
             style="max-width: 100%; max-height: 100%; object-fit: contain; position: relative; z-index: 2;">
        
        <div onclick="event.stopPropagation(); changeLightboxImage(1);" 
             style="position: absolute; right: 0; top: 80px; bottom: 80px; width: 35%; z-index: 3; cursor: pointer;"></div>
        
    </div>

    <div class="lightbox-thumbs d-flex gap-2 px-3" 
         style="position: absolute; bottom: 10px; max-width: 100vw; height: 70px; align-items: center; z-index: 10002; overflow-x: auto;"></div>
</div>


<script>
    let galleryImages = [];
    let currentImageIndex = 0;
    
    let touchStartX = 0;
    let touchEndX = 0;

    document.addEventListener('DOMContentLoaded', function() {
        var navMain = document.getElementById('navbarNav');
        if(navMain) {
            var navLinks = navMain.querySelectorAll('a');
            navLinks.forEach(function(link) {
                link.addEventListener('click', function() {
                    if (navMain.classList.contains('show')) {
                        var bsCollapse = bootstrap.Collapse.getInstance(navMain);
                        if (bsCollapse) bsCollapse.hide();
                    }
                });
            });
        }
    });

    const modalPropiedad = new bootstrap.Modal(document.getElementById('modalPropiedad'));

    function abrirModalPropiedad(url) {
        document.getElementById('modal-content-body').innerHTML = 
            '<div class="text-center py-5"><div class="spinner-border text-success" role="status"></div></div>';
        
        modalPropiedad.show();

        fetch(url, {'headers': {'X-Requested-With': 'XMLHttpRequest'}})
        .then(response => response.text())
        .then(html => {
            document.getElementById('modal-content-body').innerHTML = html;
        })
        .catch(err => console.error('Error cargando propiedad:', err));
    }

    function toggleDescription() {
        const shortDesc = document.getElementById('desc-short');
        const fullDesc = document.getElementById('desc-full');
        const btn = document.getElementById('btn-toggle-desc');
        
        if (shortDesc && fullDesc) {
            if (shortDesc.classList.contains('d-none')) {
                shortDesc.classList.remove('d-none');
                fullDesc.classList.add('d-none');
                btn.innerHTML = 'Ver m√°s <i class="bi bi-chevron-down ms-1"></i>';
            } else {
                shortDesc.classList.add('d-none');
                fullDesc.classList.remove('d-none');
                btn.innerHTML = 'Ver menos <i class="bi bi-chevron-up ms-1"></i>';
            }
        }
    }

   function updateMainImage(src) {
        const mainImg = document.getElementById('mainImage');
        if (mainImg) mainImg.src = src;

        document.querySelectorAll('.thumb-item').forEach(img => {
            if (img.src === src) {
                img.classList.remove('border-transparent', 'opacity-75');
                img.classList.add('border-primary', 'border-2', 'opacity-100');
            } else {
                img.classList.add('border-transparent', 'opacity-75');
                img.classList.remove('border-primary', 'border-2', 'opacity-100');
            }
        });
    }

    function openLightbox() {
        const csvInput = document.getElementById('gallery-data-csv');
        if (!csvInput) return; 

        const rawList = csvInput.value.split(',');
        galleryImages = [...new Set(rawList)].filter(url => url.trim() !== '');

        const currentSrc = document.getElementById('mainImage').src;
        let index = galleryImages.findIndex(url => currentSrc.includes(url.trim()));
        if (index === -1) index = 0;
        currentImageIndex = index;

        updateLightboxContent();
        const overlay = document.getElementById('lightbox-overlay');
        overlay.style.display = 'flex';
        
        overlay.addEventListener('touchstart', handleTouchStart, {passive: true});
        overlay.addEventListener('touchend', handleTouchEnd, {passive: true});
        
        const thumbsContainer = document.querySelector('.lightbox-thumbs');
        thumbsContainer.innerHTML = '';
        galleryImages.forEach((src, idx) => {
            const img = document.createElement('img');
            img.src = src;
            img.style.height = '50px'; 
            img.style.width = '50px';
            img.style.objectFit = 'cover';
            img.style.cursor = 'pointer';
            img.className = 'rounded-3 flex-shrink-0 ' + (idx === currentImageIndex ? 'border border-2 border-white opacity-100' : 'opacity-50');
            img.onclick = () => { currentImageIndex = idx; updateLightboxContent(); };
            thumbsContainer.appendChild(img);
        });
    }

    function closeLightbox(e) {
        if (!e || e.target.id === 'lightbox-overlay') {
            document.getElementById('lightbox-overlay').style.display = 'none';
        }
    }

    function changeLightboxImage(direction) {
        currentImageIndex += direction;
        if (currentImageIndex >= galleryImages.length) currentImageIndex = 0;
        if (currentImageIndex < 0) currentImageIndex = galleryImages.length - 1;
        updateLightboxContent();
    }

    function updateLightboxContent() {
        if (galleryImages.length === 0) return;
        const src = galleryImages[currentImageIndex];
        const imgTag = document.getElementById('lightbox-img-tag');
        if(imgTag) imgTag.src = src;
        
        const thumbs = document.querySelector('.lightbox-thumbs').children;
        Array.from(thumbs).forEach((el, idx) => {
            el.className = 'rounded-3 flex-shrink-0 ' + (idx === currentImageIndex ? 'border border-2 border-white opacity-100' : 'opacity-50');
            if (idx === currentImageIndex) el.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        });
    }

    function handleTouchStart(e) {
        touchStartX = e.changedTouches[0].screenX;
    }

    function handleTouchEnd(e) {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    }

    function handleSwipe() {
        if (touchEndX < touchStartX - 50) {
            changeLightboxImage(1);
        }
        if (touchEndX > touchStartX + 50) {
            changeLightboxImage(-1);
        }
    }

    document.addEventListener('keydown', function(e) {
        const overlay = document.getElementById('lightbox-overlay');
        if (overlay && overlay.style.display === 'flex') {
            if (e.key === 'ArrowLeft') changeLightboxImage(-1);
            if (e.key === 'ArrowRight') changeLightboxImage(1);
            if (e.key === 'Escape') closeLightbox(null);
        }
    });
    document.addEventListener('DOMContentLoaded', function() {
        let mainImgTouchStartX = 0;
        let mainImgTouchEndX = 0;
        
        document.addEventListener('touchstart', function(e) {
            const mainImg = document.getElementById('mainImage');
            if (mainImg && e.target === mainImg) {
                mainImgTouchStartX = e.changedTouches[0].screenX;
            }
        }, {passive: true});
        
        document.addEventListener('touchend', function(e) {
            const mainImg = document.getElementById('mainImage');
            if (mainImg && e.target === mainImg) {
                mainImgTouchEndX = e.changedTouches[0].screenX;
                
                const thumbs = Array.from(document.querySelectorAll('.thumb-item'));
                const currentIndex = thumbs.findIndex(t => t.classList.contains('border-primary'));
                
                if (mainImgTouchEndX < mainImgTouchStartX - 50) {
                    const nextIndex = (currentIndex + 1) % thumbs.length;
                    thumbs[nextIndex].click();
                }
                else if (mainImgTouchEndX > mainImgTouchStartX + 50) {
                    const prevIndex = currentIndex - 1 < 0 ? thumbs.length - 1 : currentIndex - 1;
                    thumbs[prevIndex].click();
                }
            }
        }, {passive: true});
    });
    document.addEventListener('DOMContentLoaded', function() {
        const modalSlug = '{{ modal_open_slug|default:"" }}';
        if (modalSlug) {
            const url = "{% url 'detalle_propiedad' slug='SLUG_PLACEHOLDER' %}".replace('SLUG_PLACEHOLDER', modalSlug);
            setTimeout(() => abrirModalPropiedad(url), 300);
        }
    });

    const originalAbrirModal = abrirModalPropiedad;
    window.abrirModalPropiedad = function(url) {
        originalAbrirModal(url);
        
        const slug = url.split('/').filter(Boolean).pop();
        const newUrl = `/propiedad/${slug}/`;
        
        history.pushState({modalOpen: true, slug: slug}, '', newUrl);
    };

    document.getElementById('modalPropiedad').addEventListener('hidden.bs.modal', function() {
        if (window.location.pathname !== '/catalogo/') {
            history.pushState({}, '', '/catalogo/');
        }
    });

    window.addEventListener('popstate', function(e) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalPropiedad'));
        if (modal) {
            modal.hide();
        }
    });
</script>
</body>
</html>