{% load humanize %}

{% with imagen_principal_url=propiedad.imagen_principal.imagen.url|default:"https://via.placeholder.com/800x500" %}

<input type="hidden" id="gallery-data-csv" 
       value="{{ imagen_principal_url }}{% for img in propiedad.imagenes.all %},{{ img.imagen.url }}{% endfor %}">

<style>
    /* Estilos del Modal (Mantenemos esto aquí porque son estilos visuales) */
    .btn-leermas { color: #198754; font-weight: 600; cursor: pointer; padding: 0; background: none; border: none; font-size: 0.9rem; }
    .btn-leermas:hover { text-decoration: underline; }
    
    /* Lightbox */
    #lightbox-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); z-index: 9999; display: none;
        flex-direction: column; justify-content: center; align-items: center;
    }
    .lightbox-img { max-width: 90%; max-height: 70vh; object-fit: contain; border-radius: 4px; }
    .lightbox-thumbs { margin-top: 20px; display: flex; gap: 10px; overflow-x: auto; max-width: 90%; padding-bottom: 10px; }
    .lightbox-thumb-img { height: 60px; width: auto; opacity: 0.5; cursor: pointer; border: 2px solid transparent; transition: 0.2s; border-radius: 4px; }
    .lightbox-thumb-img.active { opacity: 1; border-color: #fff; }
    .lightbox-nav {
        position: absolute; top: 50%; transform: translateY(-50%);
        background: rgba(255,255,255,0.1); color: white; border: none;
        font-size: 2rem; padding: 10px 20px; cursor: pointer; border-radius: 50%;
    }
    .lightbox-nav:hover { background: rgba(255,255,255,0.3); }
    .lightbox-prev { left: 20px; } .lightbox-next { right: 20px; }
</style>

<div class="modal-header border-0 pb-0">
    <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<div class="modal-body pt-0">
    <div class="row">
        <div class="col-lg-8">
            <div class="mb-2 position-relative bg-dark rounded-4 overflow-hidden">
                <img id="mainImage" src="{{ imagen_principal_url }}" 
                     class="img-fluid w-100 object-fit-cover" style="height: 450px; cursor: zoom-in;" 
                     alt="{{ propiedad.titulo }}"
                     onclick="openLightbox()"> <span class="position-absolute top-0 start-0 m-3 badge bg-success shadow">{{ propiedad.get_operacion_display }}</span>
                <div class="position-absolute bottom-0 end-0 m-3 text-white bg-dark bg-opacity-50 px-2 py-1 rounded small" 
                    style="cursor: pointer;" 
                    onclick="openLightbox()">
                    <i class="bi bi-arrows-fullscreen me-1"></i> Ampliar
                </div>
            </div>

            {% if propiedad.imagenes.all.count > 0 %}
            <div class="d-flex gap-2 mb-4 overflow-auto pb-2" style="scrollbar-width: thin;">
                <img src="{{ imagen_principal_url }}" onclick="updateMainImage(this.src)"
                     class="rounded-3 cursor-pointer border border-2 border-primary thumb-item" 
                     style="height: 70px; width: 70px; object-fit: cover; flex-shrink: 0;">
                
                {% for img in propiedad.imagenes.all %}
                    {% if img.imagen.url != imagen_principal_url %}
                    <img src="{{ img.imagen.url }}" onclick="updateMainImage(this.src)" 
                         class="rounded-3 cursor-pointer border border-transparent opacity-75 hover-opacity-100 thumb-item" 
                         style="height: 70px; width: 70px; object-fit: cover; flex-shrink: 0;">
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}

            <h2 class="text-technical fw-bold mb-2">{{ propiedad.titulo }}</h2>
            
            <div class="d-flex flex-wrap align-items-center text-muted mb-4 gap-3">
                <div class="d-flex align-items-center"><i class="bi bi-geo-alt-fill text-danger me-2 fs-5"></i> <span class="fs-6">{{ propiedad.ubicacion_visual }}</span></div>
                <div class="border-start border-2 h-100 mx-1 d-none d-sm-block" style="height: 20px;"></div>
                <div class="d-flex align-items-center bg-light px-3 py-1 rounded-pill border"><i class="bi bi-aspect-ratio me-2 text-primary"></i><strong class="text-dark">{{ propiedad.superficie_total_m2|intcomma }} m²</strong></div>
            </div>
            
            <div class="mb-5">
                <h5 class="fw-bold text-technical border-bottom pb-2 mb-3">Descripción</h5>
                <div id="description-container">
                    <div id="desc-short" class="text-secondary" style="line-height: 1.8;">{{ propiedad.descripcion|default:"Sin descripción."|linebreaksbr|truncatechars_html:250 }}</div>
                    <div id="desc-full" class="text-secondary d-none" style="line-height: 1.8;">{{ propiedad.descripcion|default:"Sin descripción."|linebreaksbr }}</div>
                </div>
                {% if propiedad.descripcion|length > 250 %}
                    <button onclick="toggleDescription()" id="btn-toggle-desc" class="btn-leermas mt-2">Ver más <i class="bi bi-chevron-down ms-1"></i></button>
                {% endif %}
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card shadow border-0 bg-light rounded-4 sticky-top" style="top: 20px; z-index: 100;">
                <div class="card-body p-4">
                    
                    <h6 class="text-muted text-uppercase small fw-bold ls-1">Valor de Venta</h6>
                    {% if propiedad.precio_pesos_referencia %}
                        <h2 class="text-technical fw-bold mb-0">${{ propiedad.precio_pesos_referencia|intcomma }}</h2>
                        <p class="text-muted small mb-4">Valor referencial: {{ propiedad.precio_uf_visual }} UF</p>
                    {% else %}
                        <h2 class="text-technical fw-bold mb-0">{{ propiedad.precio_formateado }}</h2>
                        <p class="text-muted small mb-4">Precio a consultar</p>
                    {% endif %}
                    
                    <div class="d-grid gap-2 mb-4">
                        <a href="https://wa.me/56912345678?text=Hola,%20me%20interesa%20la%20propiedad:%20{{ propiedad.titulo }}%20(ID:%20{{ propiedad.id_ficha }})" 
                           class="btn btn-success fw-bold py-2 shadow-sm" target="_blank">
                            <i class="bi bi-whatsapp me-2"></i> Consultar por WhatsApp
                        </a>

                        <a href="/?preselect=comprar#contacto-interactivo" 
                           onclick="var m=bootstrap.Modal.getInstance(document.getElementById('modalPropiedad')); if(m) m.hide();"
                           class="btn btn-outline-dark fw-bold py-2 shadow-sm">
                            <i class="bi bi-person-lines-fill me-2"></i> Quiero que me contacten
                        </a>
                    </div>

                    <h6 class="fw-bold text-technical mb-3">Ficha Técnica</h6>
                    <ul class="list-group list-group-flush small bg-transparent">
                        
                        <li class="list-group-item bg-transparent d-flex justify-content-between px-0 py-2 border-secondary border-opacity-10">
                            <span class="text-muted">Superficie</span>
                            <strong class="text-dark">{{ propiedad.superficie_total_m2|intcomma }} m²</strong>
                        </li>
                        
                        <li class="list-group-item bg-transparent d-flex justify-content-between px-0 py-2 border-secondary border-opacity-10">
                            <span class="text-muted">Agua</span>
                            <strong class="text-dark">{{ propiedad.get_factibilidad_agua_display }}</strong>
                        </li>

                        <li class="list-group-item bg-transparent d-flex justify-content-between px-0 py-2 border-secondary border-opacity-10">
                            <span class="text-muted">Luz</span>
                            <strong class="text-dark">
                                {{ propiedad.get_factibilidad_luz_display }}
                                {% if 'SI' in propiedad.get_factibilidad_luz_display|upper %}
                                    <i class="bi bi-lightbulb-fill text-warning ms-1"></i>
                                {% else %}
                                    <i class="bi bi-lightbulb text-muted ms-1"></i>
                                {% endif %}
                            </strong>
                        </li>

                        <li class="list-group-item bg-transparent d-flex justify-content-between px-0 py-2 border-secondary border-opacity-10">
                            <span class="text-muted">Topografía</span>
                            <strong class="text-dark">{{ propiedad.get_topografia_display }}</strong>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="lightbox-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; flex-direction: column; justify-content: center; align-items: center;">
    
    <button onclick="closeLightbox(null)" class="btn-close btn-close-white" 
            style="position: absolute; top: 20px; right: 20px; z-index: 10002; width: 2rem; height: 2rem; opacity: 1;"></button>
    
    <div class="position-relative d-flex justify-content-center align-items-center" 
         style="flex: 1; width: 100%; padding: 80px 10px 80px 10px;">
        
        <!-- Zona táctil izquierda -->
        <div onclick="event.stopPropagation(); changeLightboxImage(-1);" 
             style="position: absolute; left: 0; top: 80px; bottom: 80px; width: 35%; z-index: 3; cursor: pointer;"></div>
        
        <img id="lightbox-img-tag" src="" 
             style="max-width: 100%; max-height: 100%; object-fit: contain; position: relative; z-index: 2;">
        
        <!-- Zona táctil derecha -->
        <div onclick="event.stopPropagation(); changeLightboxImage(1);" 
             style="position: absolute; right: 0; top: 80px; bottom: 80px; width: 35%; z-index: 3; cursor: pointer;"></div>
        
    </div>

    <div class="lightbox-thumbs d-flex gap-2 px-3" 
         style="position: absolute; bottom: 10px; max-width: 100vw; height: 70px; align-items: center; z-index: 10002; overflow-x: auto;"></div>
</div>

{% endwith %}